<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission UEMOA - Tra√ßabilit√© Centralis√©e</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <!-- Section UEMOA avec tous les drapeaux des pays membres -->
            <div class="uemoa-header">
                <div class="flags-grid">
                    <img src="images/flags/benin.png" alt="B√©nin" class="country-flag" title="B√©nin">
                    <img src="images/flags/cote-ivoire.png" alt="C√¥te d'Ivoire" class="country-flag" title="C√¥te d'Ivoire">
                    <img src="images/flags/guinee-bissau.png" alt="Guin√©e-Bissau" class="country-flag" title="Guin√©e-Bissau">
                    <img src="images/flags/senegal.png" alt="S√©n√©gal" class="country-flag" title="S√©n√©gal">
                    <img src="images/flags/togo.png" alt="Togo" class="country-flag" title="Togo">
                </div>
                
                <img src="images/uemoa-logo.png" alt="Logo UEMOA" class="uemoa-logo">
                <span class="uemoa-text">üèõÔ∏è Commission UEMOA</span>
                <div class="flags-grid">
                    <img src="images/flags/burkina-faso.png" alt="Burkina Faso" class="country-flag" title="Burkina Faso">
                    <img src="images/flags/mali.png" alt="Mali" class="country-flag active" title="Mali (Pays actuel)">
                    <img src="images/flags/niger.png" alt="Niger" class="country-flag" title="Niger">
                </div>
            </div>
            
            <h1>Commission UEMOA - Tra√ßabilit√© Centralis√©e</h1>
            <p>üèõÔ∏è Ouagadougou, Burkina Faso - Supervision Centrale UEMOA</p>
            <div class="workflow-badge">√âTAPES 20-21 (Libre Pratique) + 16 (Transit)</div>
        </header>

        <main class="main">
            <!-- ‚úÖ M√©triques Supervision Commission -->
            <section class="card metrics">
                <h2>üìä Supervision Centralis√©e UEMOA</h2>
                <div class="metrics-grid">
                    <div class="metric-item workflow-lp">
                        <div class="metric-value" id="workflows-libre-pratique">0</div>
                        <div class="metric-label">Workflows Libre Pratique</div>
                        <div class="metric-detail">√âtapes 20-21</div>
                    </div>
                    <div class="metric-item workflow-transit">
                        <div class="metric-value" id="workflows-transit">0</div>
                        <div class="metric-label">Workflows Transit</div>
                        <div class="metric-detail">√âtape 16</div>
                    </div>
                    <div class="metric-item countries">
                        <div class="metric-value" id="pays-actifs">0</div>
                        <div class="metric-label">Pays Membres Actifs</div>
                        <div class="metric-detail">sur 8 √âtats UEMOA</div>
                    </div>
                    <div class="metric-item corridors">
                        <div class="metric-value" id="corridors-surveilles">0</div>
                        <div class="metric-label">Corridors Surveill√©s</div>
                        <div class="metric-detail">Routes commerciales</div>
                    </div>
                </div>
                <div class="controls-row">
                    <button class="btn btn-primary" onclick="chargerStatistiques()">üîÑ Actualiser</button>
                    <button class="btn btn-accent" onclick="testerConnectiviteKit()">üîß Test Kit d'Interconnexion</button>
                    <button class="btn btn-secondary" onclick="genererRapportSupervision()">üìä Rapport Supervision</button>
                </div>
            </section>

            <!-- ‚úÖ Workflows Commission UEMOA -->
            <section class="card full-width">
                <h2>üîÑ Workflows Commission UEMOA</h2>
                <div class="workflow-info">
                    <div class="workflow-card libre-pratique">
                        <h3>üì¶ Libre Pratique (21 √©tapes)</h3>
                        <div class="workflow-steps">
                            <div class="step-group">
                                <h4>√âtapes S√©n√©gal (1-5, 17-19)</h4>
                                <div class="steps">
                                    <span class="step">1-3: Cr√©ation manifeste</span>
                                    <span class="step">4-5: Transmission Kit</span>
                                    <span class="step">17: R√©ception autorisation</span>
                                    <span class="step">18-19: Apurement/Lev√©e</span>
                                </div>
                            </div>
                            <div class="step-group">
                                <h4>√âtapes Mali (6-16)</h4>
                                <div class="steps">
                                    <span class="step">6: R√©ception manifeste</span>
                                    <span class="step">7-8: GUCE + D√©claration</span>
                                    <span class="step">9-13: Contr√¥les + Liquidation</span>
                                    <span class="step">14-16: Paiement + Transmission</span>
                                </div>
                            </div>
                            <div class="step-group commission-steps">
                                <h4>‚úÖ √âtapes Commission (20-21)</h4>
                                <div class="steps">
                                    <span class="step active">20: Notification manifeste</span>
                                    <span class="step active">21: Tra√ßabilit√© finale</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="workflow-card transit">
                        <h3>üöõ Transit (16 √©tapes)</h3>
                        <div class="workflow-steps">
                            <div class="step-group">
                                <h4>√âtapes S√©n√©gal (1-6, 15-16)</h4>
                                <div class="steps">
                                    <span class="step">1-6: Cr√©ation transit</span>
                                    <span class="step">15-16: Apurement</span>
                                </div>
                            </div>
                            <div class="step-group">
                                <h4>√âtapes Mali (11, 13-14)</h4>
                                <div class="steps">
                                    <span class="step">11: R√©ception copie</span>
                                    <span class="step">13: Arriv√©e marchandises</span>
                                    <span class="step">14: Message arriv√©e</span>
                                </div>
                            </div>
                            <div class="step-group commission-steps">
                                <h4>‚úÖ √âtape Commission (16)</h4>
                                <div class="steps">
                                    <span class="step active">16: Tra√ßabilit√© transit finale</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Onglets Tra√ßabilit√© Sp√©cialis√©e -->
            <section class="card full-width">
                <h2>üìã Tra√ßabilit√© par Type d'Op√©ration</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('all')">üîç Toutes Op√©rations</button>
                    <button class="tab-btn" onclick="showTab('manifestes')">üì¶ Manifestes (√âtape 20)</button>
                    <button class="tab-btn" onclick="showTab('declarations')">üìã D√©clarations (√âtape 21)</button>
                    <button class="tab-btn" onclick="showTab('transit')">üöõ Transit (√âtape 16)</button>
                </div>
                
                <!-- Contenu des onglets -->
                <div id="tab-all" class="tab-content active">
                    <div class="operations-controls">
                        <button class="btn btn-primary" onclick="chargerToutesOperations()">üîÑ Toutes Op√©rations</button>
                        <button class="btn btn-secondary" onclick="exporterDonnees()">üì• Export Commission</button>
                        <button class="btn btn-accent" onclick="simulerOperationTest()">üß™ Test Commission</button>
                    </div>
                    <div id="all-operations-list">
                        <p class="loading">Chargement des op√©rations trac√©es...</p>
                    </div>
                </div>
                
                <div id="tab-manifestes" class="tab-content">
                    <div class="operations-controls">
                        <button class="btn btn-primary" onclick="chargerManifestes()">üîÑ Manifestes Trac√©s</button>
                        <button class="btn btn-accent" onclick="simulerManifeste()">üß™ Test √âtape 20</button>
                    </div>
                    <div class="step-info">
                        <strong>√âTAPE 20:</strong> Notification manifeste depuis Kit d'Interconnexion ‚Üí Commission UEMOA
                    </div>
                    <div id="manifestes-list">
                        <p class="loading">Chargement manifestes trac√©s...</p>
                    </div>
                </div>
                
                <div id="tab-declarations" class="tab-content">
                    <div class="operations-controls">
                        <button class="btn btn-primary" onclick="chargerDeclarations()">üîÑ D√©clarations Trac√©es</button>
                        <button class="btn btn-accent" onclick="simulerDeclaration()">üß™ Test √âtape 21</button>
                    </div>
                    <div class="step-info">
                        <strong>√âTAPE 21:</strong> Finalisation workflow libre pratique ‚Üí Commission UEMOA
                    </div>
                    <div id="declarations-list">
                        <p class="loading">Chargement d√©clarations trac√©es...</p>
                    </div>
                </div>
                
                <div id="tab-transit" class="tab-content">
                    <div class="operations-controls">
                        <button class="btn btn-primary" onclick="chargerTransit()">üîÑ Transit Trac√©</button>
                        <button class="btn btn-accent" onclick="simulerTransit()">üß™ Test √âtape 16</button>
                    </div>
                    <div class="step-info">
                        <strong>√âTAPE 16:</strong> Tra√ßabilit√© finale transit ‚Üí Commission UEMOA
                    </div>
                    <div id="transit-list">
                        <p class="loading">Chargement transit trac√©...</p>
                    </div>
                </div>
            </section>

            <!-- ‚úÖ Graphiques Supervision -->
            <section class="card">
                <h2>üìà R√©partition par √âtape Workflow</h2>
                <canvas id="chart-etapes-workflows" width="400" height="200"></canvas>
            </section>

            <section class="card">
                <h2>üó∫Ô∏è Pays Membres UEMOA - Activit√©</h2>
                <div id="pays-uemoa-list">
                    <p class="loading">Chargement activit√© pays...</p>
                </div>
            </section>

            <!-- ‚úÖ Tests Kit d'Interconnexion -->
            <section class="card full-width">
                <h2>üîß Tests Kit d'Interconnexion UEMOA</h2>
                <p>Testez la connectivit√© avec le Kit d'Interconnexion h√©berg√© dans chaque pays membre.</p>
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="testerConnectiviteKit()">
                        üîó Test Kit d'Interconnexion
                    </button>
                    <button class="btn btn-secondary" onclick="lancerDiagnosticKit()">
                        ü©∫ Diagnostic Complet
                    </button>
                    <button class="btn btn-accent" onclick="testerNotificationVersKit()">
                        üìä Test Notification Commission
                    </button>
                    <button class="btn btn-warning" onclick="synchroniserAvecKit()">
                        üîÑ Synchronisation Kit
                    </button>
                </div>
                <div id="test-results" class="test-results">
                    <p class="text-muted">Cliquez sur un bouton pour tester la connectivit√© avec le Kit d'Interconnexion.</p>
                </div>
            </section>

            <!-- ‚úÖ Journal Supervision Commission -->
            <section class="card full-width">
                <h2>üìú Journal Supervision Commission UEMOA</h2>
                <div class="log-controls">
                    <button class="btn btn-secondary" onclick="viderJournal()">üóëÔ∏è Vider Journal</button>
                    <label>
                        <input type="checkbox" id="auto-scroll" checked> Auto-scroll
                    </label>
                    <div class="log-filter">
                        <select id="log-filter-level">
                            <option value="all">Tous les niveaux</option>
                            <option value="ETAPE_20">√âtape 20</option>
                            <option value="ETAPE_21">√âtape 21</option>
                            <option value="ETAPE_16">√âtape 16</option>
                            <option value="KIT_TEST">Tests Kit</option>
                            <option value="ERROR">Erreurs</option>
                        </select>
                    </div>
                </div>
                <div id="activity-log" class="activity-log">
                    <!-- Les entr√©es du journal appara√Ætront ici -->
                </div>
            </section>

            <!-- ‚úÖ √âtats Membres UEMOA -->
            <section class="card full-width">
                <h2>üåç √âtats Membres UEMOA Surveill√©s</h2>
                <div class="pays-uemoa-grid">
                    <div class="pays-card cotier">
                        <h3>üèñÔ∏è Pays C√¥tiers</h3>
                        <div class="pays-list">
                            <div class="pays-item" data-pays="SEN">
                                <span class="pays-flag">üá∏üá≥</span>
                                <span class="pays-info">
                                    <strong>S√©n√©gal</strong><br>
                                    <small>Dakar - Prime abord</small>
                                </span>
                                <span class="pays-status" id="status-SEN">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="CIV">
                                <span class="pays-flag">üá®üáÆ</span>
                                <span class="pays-info">
                                    <strong>C√¥te d'Ivoire</strong><br>
                                    <small>Abidjan - Prime abord</small>
                                </span>
                                <span class="pays-status" id="status-CIV">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="BEN">
                                <span class="pays-flag">üáßüáØ</span>
                                <span class="pays-info">
                                    <strong>B√©nin</strong><br>
                                    <small>Cotonou - Prime abord</small>
                                </span>
                                <span class="pays-status" id="status-BEN">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="TGO">
                                <span class="pays-flag">üáπüá¨</span>
                                <span class="pays-info">
                                    <strong>Togo</strong><br>
                                    <small>Lom√© - Prime abord</small>
                                </span>
                                <span class="pays-status" id="status-TGO">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="GNB">
                                <span class="pays-flag">üá¨üáº</span>
                                <span class="pays-info">
                                    <strong>Guin√©e-Bissau</strong><br>
                                    <small>Bissau - Prime abord</small>
                                </span>
                                <span class="pays-status" id="status-GNB">‚ö™</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pays-card hinterland">
                        <h3>üèîÔ∏è Pays Hinterland</h3>
                        <div class="pays-list">
                            <div class="pays-item" data-pays="MLI">
                                <span class="pays-flag">üá≤üá±</span>
                                <span class="pays-info">
                                    <strong>Mali</strong><br>
                                    <small>Bamako - Destination</small>
                                </span>
                                <span class="pays-status" id="status-MLI">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="BFA">
                                <span class="pays-flag">üáßüá´</span>
                                <span class="pays-info">
                                    <strong>Burkina Faso</strong><br>
                                    <small>Ouagadougou - Destination</small>
                                </span>
                                <span class="pays-status" id="status-BFA">‚ö™</span>
                            </div>
                            <div class="pays-item" data-pays="NER">
                                <span class="pays-flag">üá≥üá™</span>
                                <span class="pays-info">
                                    <strong>Niger</strong><br>
                                    <small>Niamey - Destination</small>
                                </span>
                                <span class="pays-status" id="status-NER">‚ö™</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="notification" class="notification"></div>
    
    <script>
        // ============================================================================
        // COMMISSION UEMOA - Script JavaScript (Version Corrig√©e FINALE)
        // R√¥le: √âTAPES 20-21 (Libre Pratique) + √âTAPE 16 (Transit)
        // Si√®ge: Ouagadougou, Burkina Faso
        // ============================================================================

        // Configuration API Commission UEMOA
        const API_BASE = window.location.origin + '/api';
        const KIT_MULESOFT_URL = 'https://kit-interconnexion-uemoa-v4320.m3jzw3-1.deu-c1.cloudhub.io/api/v1';
        window.SYSTEME_TYPE = 'COMMISSION_UEMOA';
        window.ORGANISME_CODE = 'UEMOA';
        window.SIEGE = 'OUAGADOUGOU_BURKINA_FASO';

        let statusInterval;
        let refreshInterval;
        let chartEtapesWorkflows;
        let activeTab = 'all';

        // ‚úÖ Pays membres UEMOA surveill√©s
        const PAYS_UEMOA = {
            // Pays c√¥tiers (de prime abord)
            'SEN': { nom: 'S√©n√©gal', ville: 'Dakar', type: 'COTIER', flag: 'üá∏üá≥' },
            'CIV': { nom: 'C√¥te d\'Ivoire', ville: 'Abidjan', type: 'COTIER', flag: 'üá®üáÆ' },
            'BEN': { nom: 'B√©nin', ville: 'Cotonou', type: 'COTIER', flag: 'üáßüáØ' },
            'TGO': { nom: 'Togo', ville: 'Lom√©', type: 'COTIER', flag: 'üáπüá¨' },
            'GNB': { nom: 'Guin√©e-Bissau', ville: 'Bissau', type: 'COTIER', flag: 'üá¨üáº' },
            
            // Pays hinterland (de destination)
            'MLI': { nom: 'Mali', ville: 'Bamako', type: 'HINTERLAND', flag: 'üá≤üá±' },
            'BFA': { nom: 'Burkina Faso', ville: 'Ouagadougou', type: 'HINTERLAND', flag: 'üáßüá´' },
            'NER': { nom: 'Niger', ville: 'Niamey', type: 'HINTERLAND', flag: 'üá≥üá™' }
        };

        // Initialisation Commission UEMOA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üèõÔ∏è Initialisation Commission UEMOA - Supervision Centrale');
            console.log('üìç Si√®ge: Ouagadougou, Burkina Faso');
            console.log('üîç R√¥le: Tra√ßabilit√© √âTAPES 20-21 (Libre Pratique) + √âTAPE 16 (Transit)');
            
            initGraphiques();
            verifierStatutCommission();
            statusInterval = setInterval(verifierStatutCommission, 45000);
            
            chargerToutesLesDonneesCommission();
            refreshInterval = setInterval(chargerToutesLesDonneesCommission, 20000);
            
            ajouterLogSupervision('SYSTEME', 'Commission UEMOA d√©marr√©e', 'Supervision centrale UEMOA activ√©e');
            initialiserSuiviPaysUEMOA();
        });

        // ‚úÖ V√©rification statut Commission UEMOA
        async function verifierStatutCommission() {
            try {
                console.log('üè• [Commission] V√©rification statut syst√®me central...');
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'UP') {
                    console.log('‚úÖ [Commission] Syst√®me op√©rationnel');
                    if (data.commission) {
                        console.log('üèõÔ∏è Commission UEMOA:', data.commission.nom);
                        console.log('üìç Si√®ge:', data.commission.siege);
                    }
                }
            } catch (error) {
                console.error('‚ùå [Commission] Erreur v√©rification statut:', error);
            }
        }

        // ‚úÖ Gestion des onglets Commission
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            activeTab = tabName;
            
            switch(tabName) {
                case 'manifestes': chargerManifestes(); break;
                case 'declarations': chargerDeclarations(); break;
                case 'transit': chargerTransit(); break;
                default: chargerToutesOperations(); break;
            }
        }

        // ‚úÖ CORRECTION: Charger MANIFESTES (√âTAPE 20) - FONCTION COMPL√àTE
        async function chargerManifestes() {
            try {
                console.log('üì¶ [Commission] Chargement manifestes √âTAPE 20...');
                
                const response = await fetch(`${API_BASE}/tracabilite/manifeste?limite=30`);
                const data = await response.json();
                
                const manifestesList = document.getElementById('manifestes-list');
                
                if (data.status === 'SUCCESS' && data.manifestes && data.manifestes.length > 0) {
                    manifestesList.innerHTML = data.manifestes.map(manifeste => `
                        <div class="operation-item manifeste-item commission-item">
                            <div class="operation-header">
                                <div class="operation-title">üì¶ ${manifeste.typeOperation || 'TRANSMISSION_MANIFESTE'}</div>
                                <div class="operation-time">${formatDateTime(manifeste.dateEnregistrement)}</div>
                                <div class="etape-badge etape-20">√âTAPE 20</div>
                            </div>
                            <div class="operation-details commission-details">
                                <div><strong>N¬∞ Op√©ration:</strong> ${manifeste.numeroOperation || manifeste.id}</div>
                                <div><strong>Corridor:</strong> ${manifeste.corridor}</div>
                                <div><strong>Navire:</strong> ${manifeste.navire || 'N/A'}</div>
                                <div><strong>Nb Articles:</strong> ${manifeste.nombreArticles || 'N/A'}</div>
                                <div><strong>Commission:</strong> <span class="badge badge-commission">TRAC√â UEMOA</span></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    manifestesList.innerHTML = `
                        <div class="no-data commission-no-data">
                            <h3>üì¶ Aucun manifeste trac√©</h3>
                            <p>Aucune notification manifeste (√âTAPE 20) re√ßue depuis le Kit d'Interconnexion.</p>
                            <button class="btn btn-accent" onclick="simulerManifeste()">üß™ Tester √âTAPE 20</button>
                        </div>
                    `;
                }
                
                ajouterLogSupervision('LOAD_ETAPE_20', 'Manifestes charg√©s', `${data.manifestes?.length || 0} notifications`);
                
            } catch (error) {
                console.error('‚ùå [Commission] Erreur chargement manifestes:', error);
                document.getElementById('manifestes-list').innerHTML = `
                    <div class="error-message commission-error">
                        <p class="text-danger">‚ùå Erreur chargement manifestes √âTAPE 20</p>
                        <button class="btn btn-secondary" onclick="chargerManifestes()">üîÑ R√©essayer</button>
                    </div>
                `;
            }
        }

        // ‚úÖ CORRECTION: Charger D√âCLARATIONS (√âTAPE 21) - FONCTION COMPL√àTE
        async function chargerDeclarations() {
            try {
                console.log('üìã [Commission] Chargement d√©clarations √âTAPE 21...');
                
                const response = await fetch(`${API_BASE}/tracabilite/declaration?limite=30`);
                const data = await response.json();
                
                const declarationsList = document.getElementById('declarations-list');
                
                if (data.status === 'SUCCESS' && data.declarations && data.declarations.length > 0) {
                    declarationsList.innerHTML = data.declarations.map(declaration => `
                        <div class="operation-item declaration-item commission-item">
                            <div class="operation-header">
                                <div class="operation-title">üìã ${declaration.typeOperation || 'COMPLETION_LIBRE_PRATIQUE'}</div>
                                <div class="operation-time">${formatDateTime(declaration.dateEnregistrement)}</div>
                                <div class="etape-badge etape-21">√âTAPE 21</div>
                            </div>
                            <div class="operation-details commission-details">
                                <div><strong>N¬∞ Op√©ration:</strong> ${declaration.numeroOperation || declaration.id}</div>
                                <div><strong>Corridor:</strong> ${declaration.corridor}</div>
                                <div><strong>D√©claration:</strong> ${declaration.numeroDeclaration || 'N/A'}</div>
                                <div><strong>Montant:</strong> ${declaration.valeurTotaleCaf ? formatNumber(declaration.valeurTotaleCaf) + ' FCFA' : 'N/A'}</div>
                                <div><strong>Finalisation:</strong> <span class="badge badge-final">WORKFLOW TERMIN√â</span></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    declarationsList.innerHTML = `
                        <div class="no-data commission-no-data">
                            <h3>üìã Aucune d√©claration trac√©e</h3>
                            <p>Aucune finalisation workflow (√âTAPE 21) re√ßue depuis le Kit d'Interconnexion.</p>
                            <button class="btn btn-accent" onclick="simulerDeclaration()">üß™ Tester √âTAPE 21</button>
                        </div>
                    `;
                }
                
                ajouterLogSupervision('LOAD_ETAPE_21', 'D√©clarations charg√©es', `${data.declarations?.length || 0} finalisations`);
                
            } catch (error) {
                console.error('‚ùå [Commission] Erreur chargement d√©clarations:', error);
                document.getElementById('declarations-list').innerHTML = `
                    <div class="error-message commission-error">
                        <p class="text-danger">‚ùå Erreur chargement d√©clarations √âTAPE 21</p>
                        <button class="btn btn-secondary" onclick="chargerDeclarations()">üîÑ R√©essayer</button>
                    </div>
                `;
            }
        }

        // ‚úÖ CORRECTION: Charger TRANSIT (√âTAPE 16) - FONCTION COMPL√àTE
        async function chargerTransit() {
            try {
                console.log('üöõ [Commission] Chargement transit √âTAPE 16...');
                
                const response = await fetch(`${API_BASE}/tracabilite/enregistrer?limite=30&etapeWorkflow=16`);
                const data = await response.json();
                
                const transitList = document.getElementById('transit-list');
                
                if (data.status === 'SUCCESS' && data.operations && data.operations.length > 0) {
                    const operationsTransit = data.operations.filter(op => 
                        op.typeOperation && (op.typeOperation.includes('TRANSIT') || op.etapeWorkflow === '16')
                    );
                    
                    if (operationsTransit.length > 0) {
                        transitList.innerHTML = operationsTransit.map(transit => `
                            <div class="operation-item transit-item commission-item">
                                <div class="operation-header">
                                    <div class="operation-title">üöõ ${transit.typeOperation || 'COMPLETION_TRANSIT'}</div>
                                    <div class="operation-time">${formatDateTime(transit.dateEnregistrement)}</div>
                                    <div class="etape-badge etape-16">√âTAPE 16</div>
                                </div>
                                <div class="operation-details commission-details">
                                    <div><strong>N¬∞ Op√©ration:</strong> ${transit.numeroOperation || transit.id}</div>
                                    <div><strong>Corridor:</strong> ${transit.corridor}</div>
                                    <div><strong>Transit:</strong> ${transit.donneesMetier?.numero_declaration_transit || 'N/A'}</div>
                                    <div><strong>Tra√ßabilit√©:</strong> <span class="badge badge-transit">TRANSIT FINALIS√â</span></div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        transitList.innerHTML = `
                            <div class="no-data commission-no-data">
                                <h3>üöõ Aucune op√©ration transit trac√©e</h3>
                                <p>Aucune finalisation transit (√âTAPE 16) re√ßue depuis le Kit d'Interconnexion.</p>
                                <button class="btn btn-accent" onclick="simulerTransit()">üß™ Tester √âTAPE 16</button>
                            </div>
                        `;
                    }
                    
                    ajouterLogSupervision('LOAD_ETAPE_16', 'Transit charg√©', `${operationsTransit.length} op√©rations`);
                } else {
                    transitList.innerHTML = `
                        <div class="no-data commission-no-data">
                            <h3>üöõ Aucune op√©ration transit</h3>
                            <p>Aucune op√©ration de transit trac√©e pour le moment.</p>
                            <button class="btn btn-accent" onclick="simulerTransit()">üß™ Tester √âTAPE 16</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå [Commission] Erreur chargement transit:', error);
                document.getElementById('transit-list').innerHTML = `
                    <div class="error-message commission-error">
                        <p class="text-danger">‚ùå Erreur chargement transit √âTAPE 16</p>
                        <button class="btn btn-secondary" onclick="chargerTransit()">üîÑ R√©essayer</button>
                    </div>
                `;
            }
        }

        // ‚úÖ Charger TOUTES op√©rations
        async function chargerToutesOperations() {
            try {
                console.log('üîç [Commission] Chargement toutes op√©rations trac√©es...');
                
                const response = await fetch(`${API_BASE}/tracabilite/enregistrer?limite=50`);
                const data = await response.json();
                
                const operationsList = document.getElementById('all-operations-list');
                
                if (data.status === 'SUCCESS' && data.operations && data.operations.length > 0) {
                    operationsList.innerHTML = data.operations.map(op => {
                        const isManifeste = op.typeOperation && op.typeOperation.includes('MANIFESTE');
                        const isDeclaration = op.typeOperation && (op.typeOperation.includes('DECLARATION') || op.typeOperation.includes('COMPLETION'));
                        const isTransit = op.typeOperation && op.typeOperation.includes('TRANSIT');
                        
                        let etapeClass = '';
                        let etapeLabel = '';
                        
                        if (isManifeste || op.etapeWorkflow === '20') {
                            etapeClass = 'etape-20';
                            etapeLabel = '√âTAPE 20';
                        } else if (isDeclaration || op.etapeWorkflow === '21') {
                            etapeClass = 'etape-21';  
                            etapeLabel = '√âTAPE 21';
                        } else if (isTransit || op.etapeWorkflow === '16') {
                            etapeClass = 'etape-16';
                            etapeLabel = '√âTAPE 16';
                        } else {
                            etapeClass = 'etape-other';
                            etapeLabel = 'AUTRE';
                        }
                        
                        return `
                            <div class="operation-item commission-item">
                                <div class="operation-header">
                                    <div class="operation-title">
                                        ${getOperationIcon(op.typeOperation)} ${op.typeOperation || 'OPERATION'}
                                    </div>
                                    <div class="operation-time">
                                        ${formatDateTime(op.dateEnregistrement)}
                                    </div>
                                    <div class="etape-badge ${etapeClass}">${etapeLabel}</div>
                                </div>
                                <div class="operation-details commission-details">
                                    <div><strong>N¬∞ Op√©ration:</strong> ${op.numeroOperation || op.id}</div>
                                    <div><strong>Corridor:</strong> ${op.corridor || (op.paysOrigine + ' ‚Üí ' + op.paysDestination)}</div>
                                    <div><strong>Type:</strong> <span class="badge badge-${isManifeste ? 'manifeste' : isDeclaration ? 'declaration' : isTransit ? 'transit' : 'other'}">${isManifeste ? 'MANIFESTE' : isDeclaration ? 'D√âCLARATION' : isTransit ? 'TRANSIT' : 'AUTRE'}</span></div>
                                    <div><strong>Statut:</strong> <span class="badge badge-commission">TRAC√â COMMISSION</span></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    operationsList.innerHTML = `
                        <div class="no-data commission-no-data">
                            <h3>üìä Aucune op√©ration trac√©e</h3>
                            <p>Aucune op√©ration n'a encore √©t√© re√ßue depuis le Kit d'Interconnexion.</p>
                            <button class="btn btn-accent" onclick="simulerOperationTest()">üß™ Tester Commission</button>
                        </div>
                    `;
                }
                
                ajouterLogSupervision('LOAD_ALL', 'Toutes op√©rations charg√©es', `${data.operations?.length || 0} op√©rations`);
                
            } catch (error) {
                console.error('‚ùå [Commission] Erreur chargement op√©rations:', error);
                document.getElementById('all-operations-list').innerHTML = `
                    <div class="error-message commission-error">
                        <p class="text-danger">‚ùå Erreur chargement op√©rations Commission</p>
                        <p class="text-muted">D√©tails: ${error.message}</p>
                        <button class="btn btn-secondary" onclick="chargerToutesOperations()">üîÑ R√©essayer</button>
                    </div>
                `;
                ajouterLogSupervision('ERROR', '√âchec chargement op√©rations', error.message);
            }
        }

        // ‚úÖ CORRECTION: Charger statistiques avec mise √† jour graphiques
        async function chargerStatistiques() {
            try {
                const response = await fetch(`${API_BASE}/statistiques`);
                const data = await response.json();
                
                // Mise √† jour des m√©triques
                document.getElementById('workflows-libre-pratique').textContent = data.global?.workflowsLibrePratique || 0;
                document.getElementById('workflows-transit').textContent = data.global?.workflowsTransit || 0;
                document.getElementById('pays-actifs').textContent = data.global?.paysConnectes || 0;
                document.getElementById('corridors-surveilles').textContent = data.corridors?.length || 0;
                
                // ‚úÖ CORRECTION: Mise √† jour du graphique
                if (data.parType && Object.keys(data.parType).length > 0) {
                    mettreAJourGraphiqueEtapes(data.parType);
                }
                
                // ‚úÖ CORRECTION: Affichage des pays
                if (data.parPays && data.parPays.length > 0) {
                    afficherPaysUEMOA(data.parPays);
                }
                
                ajouterLogSupervision('STATS', 'Statistiques mises √† jour', 
                    `${data.global?.operationsTotal || 0} op√©rations`);
                
            } catch (error) {
                console.error('‚ùå [Commission] Erreur chargement statistiques:', error);
                ajouterLogSupervision('ERROR', 'Erreur statistiques', error.message);
            }
        }

        // ‚úÖ Charger toutes les donn√©es Commission
        async function chargerToutesLesDonneesCommission() {
            await chargerStatistiques();
            if (activeTab === 'manifestes') await chargerManifestes();
            else if (activeTab === 'declarations') await chargerDeclarations();
            else if (activeTab === 'transit') await chargerTransit();
            else await chargerToutesOperations();
        }

        // ‚úÖ Initialiser graphiques Commission
        function initGraphiques() {
            const ctxEtapes = document.getElementById('chart-etapes-workflows');
            chartEtapesWorkflows = new Chart(ctxEtapes, {
                type: 'doughnut',
                data: {
                    labels: ['√âtape 20 (Manifeste)', '√âtape 21 (Finalisation)', '√âtape 16 (Transit)', 'Autres'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#feca57']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'R√©partition par √âtape Commission UEMOA'
                        }
                    }
                }
            });
        }

        // ‚úÖ CORRECTION: Mise √† jour graphique √©tapes
        function mettreAJourGraphiqueEtapes(operationsParType) {
            if (!chartEtapesWorkflows || !chartEtapesWorkflows.data) {
                console.log('‚ö†Ô∏è [Commission] Graphique non initialis√©');
                return;
            }
            
            let etape20 = 0, etape21 = 0, etape16 = 0, autres = 0;
            
            Object.keys(operationsParType).forEach(type => {
                const count = operationsParType[type];
                const typeUpper = type.toUpperCase();
                
                if (typeUpper.includes('MANIFESTE') || typeUpper.includes('TRANSMISSION')) {
                    etape20 += count;
                } else if (typeUpper.includes('COMPLETION') || typeUpper.includes('DECLARATION')) {
                    etape21 += count;
                } else if (typeUpper.includes('TRANSIT')) {
                    etape16 += count;
                } else {
                    autres += count;
                }
            });
            
            chartEtapesWorkflows.data.datasets[0].data = [etape20, etape21, etape16, autres];
            chartEtapesWorkflows.update('none');
            
            console.log('üìä [Commission] Graphique mis √† jour:', { etape20, etape21, etape16, autres });
        }

        // ‚úÖ CORRECTION: Affichage pays UEMOA
        function afficherPaysUEMOA(statistiquesParPays) {
            const paysUEMOAList = document.getElementById('pays-uemoa-list');
            
            if (!paysUEMOAList) {
                console.log('‚ö†Ô∏è [Commission] Element pays-uemoa-list non trouv√©');
                return;
            }
            
            if (statistiquesParPays.length > 0) {
                paysUEMOAList.innerHTML = statistiquesParPays.map(pays => {
                    const paysInfo = PAYS_UEMOA[pays.code] || { nom: pays.code, ville: 'N/A', type: 'INCONNU', flag: 'üè≥Ô∏è' };
                    const totalOperations = pays.operationsEnvoyees + pays.operationsRecues;
                    
                    return `
                        <div class="pays-item ${paysInfo.type.toLowerCase()}" data-pays="${pays.code}">
                            <span class="pays-flag">${paysInfo.flag}</span>
                            <div class="pays-info">
                                <strong>${paysInfo.nom}</strong> (${pays.code})<br>
                                <small>${paysInfo.ville} - ${paysInfo.type === 'COTIER' ? 'Prime abord' : 'Destination'}</small>
                            </div>
                            <div class="pays-stats">
                                <div class="stat-item">
                                    <span class="stat-value">${pays.operationsEnvoyees}</span>
                                    <span class="stat-label">Envoy√©es</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${pays.operationsRecues}</span>
                                    <span class="stat-label">Re√ßues</span>
                                </div>
                            </div>
                            <span class="pays-status ${totalOperations > 0 ? 'active' : 'inactive'}">
                                ${totalOperations > 0 ? 'üü¢' : '‚ö™'}
                            </span>
                        </div>
                    `;
                }).join('');
            } else {
                paysUEMOAList.innerHTML = `
                    <div class="no-data commission-no-data">
                        <p>Aucune activit√© d√©tect√©e depuis les pays membres UEMOA.</p>
                    </div>
                `;
            }
        }

        // Fonction pour initialiser le suivi des pays
        function initialiserSuiviPaysUEMOA() {
            console.log('üåç [Commission] Initialisation suivi pays membres UEMOA...');
            
            Object.keys(PAYS_UEMOA).forEach(codePays => {
                const paysInfo = PAYS_UEMOA[codePays];
                console.log(`üìç ${paysInfo.flag} ${paysInfo.nom} (${codePays})`);
                
                const statusElement = document.getElementById(`status-${codePays}`);
                if (statusElement) {
                    statusElement.textContent = '‚ö™';
                }
            });
            
            ajouterLogSupervision('INIT_PAYS', 'Pays UEMOA initialis√©s', `${Object.keys(PAYS_UEMOA).length} pays membres`);
        }

        // ‚úÖ Tests Kit d'Interconnexion depuis Commission
        async function testerConnectiviteKit() {
            ajouterLogSupervision('TEST_KIT', 'Test connectivit√© Kit', 'V√©rification Kit MuleSoft...');
            afficherNotification('üîß Test connectivit√© Kit d\'Interconnexion...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/kit/test?type=health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'COMMISSION_UEMOA_DASHBOARD'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    afficherNotification('‚úÖ Kit d\'Interconnexion accessible', 'success');
                    ajouterLogSupervision('TEST_KIT', 'Kit accessible', `Latence: ${data.resultat?.latence || 'N/A'}ms`);
                    
                    document.getElementById('test-results').innerHTML = `
                        <div class="test-result success">
                            <h4>‚úÖ Test Connectivit√© Kit R√©ussi</h4>
                            <p><strong>Status:</strong> ${data.resultat?.status || 'UP'}</p>
                            <p><strong>Latence:</strong> ${data.resultat?.latence || 'N/A'} ms</p>
                            <p><strong>Source:</strong> ${data.source || 'Commission ‚Üí Kit MuleSoft'}</p>
                            <small>Test√© le ${new Date().toLocaleString('fr-FR')}</small>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Kit d\'Interconnexion inaccessible', 'error');
                ajouterLogSupervision('TEST_KIT', 'Kit inaccessible', error.message);
                
                document.getElementById('test-results').innerHTML = `
                    <div class="test-result error">
                        <h4>‚ùå Test Connectivit√© Kit √âchou√©</h4>
                        <p><strong>Erreur:</strong> ${error.message}</p>
                        <p>Le Kit MuleSoft d'Interconnexion n'est pas accessible depuis la Commission.</p>
                        <small>Test√© le ${new Date().toLocaleString('fr-FR')}</small>
                    </div>
                `;
            }
        }

        async function lancerDiagnosticKit() {
            ajouterLogSupervision('DIAGNOSTIC_KIT', 'Diagnostic Kit', 'Diagnostic complet en cours...');
            afficherNotification('ü©∫ Diagnostic complet Kit d\'Interconnexion...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/kit/diagnostic`);
                if (response.ok) {
                    const data = await response.json();
                    afficherNotification('‚úÖ Diagnostic Kit termin√©', 'success');
                    ajouterLogSupervision('DIAGNOSTIC_KIT', 'Diagnostic termin√©', 'Succ√®s');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Diagnostic Kit √©chou√©', 'error');
                ajouterLogSupervision('DIAGNOSTIC_KIT', 'Diagnostic √©chou√©', error.message);
            }
        }

        async function testerNotificationVersKit() {
            const operationTest = {
                typeOperation: 'TEST_COMMISSION_UEMOA',
                numeroOperation: `COMM_TEST_${Date.now()}`,
                paysOrigine: 'UEMOA',
                paysDestination: 'TEST',
                donneesMetier: {
                    test: true,
                    source: 'Commission UEMOA Dashboard',
                    timestamp: new Date().toISOString()
                }
            };
            
            try {
                const response = await fetch(`${API_BASE}/tracabilite/enregistrer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'COMMISSION_UEMOA_DASHBOARD_TEST'
                    },
                    body: JSON.stringify(operationTest)
                });
                
                if (response.ok) {
                    afficherNotification('‚úÖ Test notification Commission r√©ussi', 'success');
                    ajouterLogSupervision('TEST_NOTIFICATION', 'Test r√©ussi', operationTest.numeroOperation);
                    setTimeout(() => chargerToutesLesDonneesCommission(), 1000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Test notification √©chou√©', 'error');
                ajouterLogSupervision('TEST_NOTIFICATION', 'Test √©chou√©', error.message);
            }
        }

        async function synchroniserAvecKit() {
            ajouterLogSupervision('SYNC_KIT', 'Synchronisation Kit', 'Synchronisation en cours...');
            afficherNotification('üîÑ Synchronisation avec Kit d\'Interconnexion...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/kit/synchroniser`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'synchronisation', source: 'COMMISSION_UEMOA' })
                });
                
                if (response.ok) {
                    afficherNotification('‚úÖ Synchronisation Kit r√©ussie', 'success');
                    ajouterLogSupervision('SYNC_KIT', 'Synchronisation r√©ussie', 'Success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Synchronisation Kit √©chou√©e', 'error');
                ajouterLogSupervision('SYNC_KIT', 'Synchronisation √©chou√©e', error.message);
            }
        }

        // ‚úÖ Simulations sp√©cifiques Commission
        async function simulerManifeste() {
            const manifesteTest = {
                typeOperation: 'TEST_TRANSMISSION_MANIFESTE_LIBRE_PRATIQUE',
                numeroOperation: `TEST_ETAPE20_${Date.now()}`,
                paysOrigine: 'SEN',
                paysDestination: 'MLI',
                donneesMetier: {
                    numero_manifeste: Math.floor(Math.random() * 9999) + 1000,
                    navire: 'TEST VESSEL ETAPE 20',
                    consignataire: 'TEST CONSIGNEE SENEGAL',
                    port_debarquement: 'Port de Dakar',
                    nombre_articles: Math.floor(Math.random() * 5) + 1,
                    valeur_approximative: Math.floor(Math.random() * 50000000) + 1000000,
                    etape_workflow: 20
                }
            };
            await envoyerOperationTestCommission(manifesteTest, 'manifeste √âTAPE 20');
        }

        async function simulerDeclaration() {
            const declarationTest = {
                typeOperation: 'TEST_COMPLETION_LIBRE_PRATIQUE',
                numeroOperation: `TEST_ETAPE21_${Date.now()}`,
                paysOrigine: 'MLI',
                paysDestination: 'SEN',
                donneesMetier: {
                    numero_declaration: `DEC_TEST_${Math.floor(Math.random() * 9999) + 1000}`,
                    manifeste_origine: `MAN_${Math.floor(Math.random() * 9999) + 1000}`,
                    montant_paye: Math.floor(Math.random() * 5000000) + 100000,
                    reference_paiement: `PAY_TEST_${Date.now()}`,
                    workflow_complete: true,
                    etapes_totales: 21,
                    etape_workflow: 21
                }
            };
            await envoyerOperationTestCommission(declarationTest, 'd√©claration √âTAPE 21');
        }

        async function simulerTransit() {
            const transitTest = {
                typeOperation: 'TEST_COMPLETION_TRANSIT',
                numeroOperation: `TEST_ETAPE16_${Date.now()}`,
                paysOrigine: 'SEN',
                paysDestination: 'MLI',
                donneesMetier: {
                    numero_declaration_transit: `TRA_TEST_${Math.floor(Math.random() * 9999) + 1000}`,
                    transporteur: 'TEST TRANSPORT SAHEL',
                    delai_route: '72 heures',
                    itineraire: 'Test Dakar-Bamako',
                    arrivee_confirmee: true,
                    etapes_totales: 16,
                    etape_workflow: 16
                }
            };
            await envoyerOperationTestCommission(transitTest, 'transit √âTAPE 16');
        }

        async function simulerOperationTest() {
            const operationTest = {
                typeOperation: 'TEST_COMMISSION_UEMOA',
                numeroOperation: `TEST_COMM_${Date.now()}`,
                paysOrigine: 'UEMOA',
                paysDestination: 'TEST',
                donneesMetier: {
                    test: true,
                    source: 'Commission UEMOA Dashboard Test',
                    timestamp: new Date().toISOString(),
                    commission: { nom: 'Commission UEMOA', siege: 'Ouagadougou, Burkina Faso' }
                }
            };
            await envoyerOperationTestCommission(operationTest, 'test g√©n√©ral Commission');
        }

        async function envoyerOperationTestCommission(operation, typeOperation) {
            try {
                ajouterLogSupervision('TEST_SIMULATION', `Simulation ${typeOperation}`, operation.numeroOperation);
                
                const response = await fetch(`${API_BASE}/tracabilite/enregistrer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'COMMISSION_DASHBOARD_TEST'
                    },
                    body: JSON.stringify(operation)
                });
                
                if (response.ok) {
                    afficherNotification(`‚úÖ ${typeOperation.toUpperCase()} test enregistr√©`, 'success');
                    ajouterLogSupervision('TEST_SIMULATION', `Simulation ${typeOperation} r√©ussie`, operation.numeroOperation);
                    setTimeout(() => chargerToutesLesDonneesCommission(), 1000);
                } else {
                    const error = await response.json();
                    afficherNotification(`‚ùå Erreur test ${typeOperation}: ${error.message}`, 'error');
                }
            } catch (error) {
                afficherNotification(`‚ùå Erreur technique test ${typeOperation}`, 'error');
                ajouterLogSupervision('ERROR', `√âchec simulation ${typeOperation}`, error.message);
            }
        }

        async function genererRapportSupervision() {
            try {
                ajouterLogSupervision('RAPPORT', 'G√©n√©ration rapport', 'En cours...');
                afficherNotification('üìä G√©n√©ration rapport supervision UEMOA...', 'info');
                
                const response = await fetch(`${API_BASE}/rapports/exporter?format=csv&type=commission`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commission-uemoa-rapport-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    afficherNotification('üì• Rapport supervision UEMOA g√©n√©r√© (CSV)', 'success');
                    ajouterLogSupervision('RAPPORT', 'Rapport g√©n√©r√©', 'Format CSV');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Erreur g√©n√©ration rapport', 'error');
                ajouterLogSupervision('ERROR', 'Erreur rapport', error.message);
            }
        }

        async function exporterDonnees() {
            try {
                const response = await fetch(`${API_BASE}/rapports/exporter?format=csv&type=commission`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commission-uemoa-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    afficherNotification('üì• Donn√©es Commission UEMOA export√©es (CSV)', 'success');
                    ajouterLogSupervision('EXPORT', 'Export Commission effectu√© (CSV)');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                afficherNotification('‚ùå Erreur export donn√©es Commission', 'error');
                ajouterLogSupervision('ERROR', 'Erreur export', error.message);
            }
        }

        // ‚úÖ Journal supervision Commission
        function ajouterLogSupervision(type, operation, details = '') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleString('fr-FR');
            
            const filterLevel = document.getElementById('log-filter-level')?.value;
            if (filterLevel && filterLevel !== 'all' && type !== filterLevel) {
                return;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry commission-log ${type.toLowerCase()}`;
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-type">${getOperationIcon(type)} ${type}</div>
                <div class="log-operation">${operation}</div>
                ${details ? `<div class="log-details">${details}</div>` : ''}
                <div class="log-source">Commission UEMOA</div>
            `;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
            
            if (document.getElementById('auto-scroll')?.checked) {
                logEntry.scrollIntoView({ behavior: 'smooth' });
            }
            
            console.log(`üìä [Commission UEMOA] ${type}: ${operation} - ${details}`);
        }

        function viderJournal() {
            document.getElementById('activity-log').innerHTML = '';
            ajouterLogSupervision('ADMIN', 'Journal vid√©', 'Nettoyage journal supervision');
        }

        // ‚úÖ Fonctions utilitaires
        function getOperationIcon(type) {
            const icons = {
                'TRANSMISSION_MANIFESTE_LIBRE_PRATIQUE': 'üì¶',
                'TRANSMISSION_MANIFESTE': 'üì¶',
                'COMPLETION_LIBRE_PRATIQUE': 'üìã',
                'SOUMISSION_DECLARATION_DOUANIERE': 'üìã', 
                'COMPLETION_TRANSIT': 'üöõ',
                'TRANSIT': 'üöõ',
                'TEST_COMMISSION_UEMOA': 'üß™',
                'TEST_COMMISSION': 'üß™',
                'ETAPE_20': 'üì¶',
                'ETAPE_21': 'üìã',
                'ETAPE_16': 'üöõ',
                'TEST_KIT': 'üîß',
                'DIAGNOSTIC_KIT': 'ü©∫',
                'TEST_NOTIFICATION': 'üìä',
                'SYNC_KIT': 'üîÑ',
                'TEST_SIMULATION': 'üß™',
                'SYSTEME': 'üèõÔ∏è',
                'LOAD_ETAPE_20': 'üì¶',
                'LOAD_ETAPE_21': 'üìã',
                'LOAD_ETAPE_16': 'üöõ',
                'LOAD_ALL': 'üì•',
                'STATS': 'üìä',
                'RAPPORT': 'üìä',
                'EXPORT': 'üì•',
                'NAVIGATION': 'üß≠',
                'INIT_PAYS': 'üåç',
                'FILTER': 'üîç',
                'ADMIN': '‚öôÔ∏è',
                'ERROR': '‚ùå'
            };
            return icons[type] || 'üìÑ';
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Date inconnue';
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        function formatNumber(num) {
            if (!num && num !== 0) return 'N/A';
            return num.toLocaleString('fr-FR');
        }

        function afficherNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        // ‚úÖ Nettoyage lors de la fermeture
        window.addEventListener('beforeunload', () => {
            if (statusInterval) clearInterval(statusInterval);
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>